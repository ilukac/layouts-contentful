dist: trusty
sudo: false

language: php

php:
  - 7.1
  - 7.2

cache:
  directories:
    - $HOME/.composer/cache/files

env:
  - PHPUNIT_CONFIG="phpunit.xml" SYMFONY_VERSION="~3.4.0"
  - PHPUNIT_CONFIG="phpunit.xml" SYMFONY_VERSION="~4.1.0"
  - PHPUNIT_CONFIG="phpunit.xml" SYMFONY_VERSION="^4.2@dev"

matrix:
  include:
    -
      php: 7.1
      env: PHPUNIT_CONFIG="phpunit.xml" SYMFONY_VERSION="~3.4.0" DEPS="low"
    -
      php: 7.2
      env: RUN_PHPSTAN="yes"

branches:
  only:
    - master
    - /^\d.\d+-release$/

before_script:
  - phpenv config-rm xdebug.ini
  - echo "memory_limit=-1" >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini

  # Read-only OAuth token to work around GitHub API rate limits
  - composer config -g github-oauth.github.com "4b3b0a83ea27d9544d3608a384c7a14625a98804"

  - if [ "$SYMFONY_VERSION" != "" ] ; then composer require --no-update symfony/symfony:$SYMFONY_VERSION ; fi

  - |
    if [ "$DEPS" = "low" ] ; then
      composer update --no-suggest --prefer-dist --prefer-lowest --prefer-stable
    else
      composer update --no-suggest --prefer-dist
    fi

script:
  - composer validate --strict
  - if [ "$PHPUNIT_CONFIG" != "" ] ; then vendor/bin/phpunit -c $PHPUNIT_CONFIG --colors=always ; fi
  - if [ "$RUN_PHPSTAN" != "" ] ; then composer phpstan ; fi
  - if [ "$RUN_PHPSTAN" != "" ] ; then composer phpstan-tests ; fi

notifications:
  email: false
  slack:
    secure: aqlF/DrhqMBHzygeCgqaLPs23hvBVlzpWnsB31JcUB0yzFLZHtG3U5JlA0FQzh4gqbdCpC2Ct4JLYEI1c+ggSf47nCfjxV2h5YiwvgGLYDAwWQlCXrCOk4sP6EfR30lKycrQggaXaJkx/ZzQYLCM3F83HuJq/NGlwsPe1NZedp/AC1EpVEs8eX1bXTaZrGLUnCH0/rEv9NqLUyEUIdFvX/3YaSP8etdcuwLhoVxfQ4d0bQc6QD0FK2hZ/fRLrtjmJXQfFclcS8UP5cCBvEpW/M1oMpCR7ZiqhcjD/5QljdJTiINIv68a8W3wiy8f/15B3DqT1JMuaue7Lb5MMIs2SVtMoKlZ70yfk7cWKsE6YZqA1zqQQqopYnKLFWScaGXkne49rK4I+ijqpNGWMlmHcoMpSrGD0rzBIn9iZyKDPchj+Hkrj4BapGBqZRmDbbBaGgqwk8ABTyitMAABzIsxsZTkKjaEO6ybMjPo9SnuX3H55tAU9ZW9aYrpWlViJIV+NUUwppfqvI2pqxzdqDmLxDhk/LU7yH154BGrMoXnhxrHajQZVU6XrozWCGRU4rCkFA73jzr5YlaSX+LzF1TCmcTMtjbNCI+Ad2gtHfhWfmCoJeOkBZiL+n0ueOWG5Uf03/wDdwPCWvGIk3uF8vNxobLfSDOwyk8Ww6zkaYyKFwY=
    on_success: change
    on_failure: always
    on_pull_requests: false

git:
  depth: 1
